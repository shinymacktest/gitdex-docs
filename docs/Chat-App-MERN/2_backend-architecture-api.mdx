---
title: "Backend Architecture and API"
description: "Details on the server-side architecture, data models, API endpoints, and core functionalities."
sidebar_position: 2
---

# Backend Architecture and API
<TOC />

## System Purpose

The backend serves as the core server-side component of the application, managing user authentication, data persistence, real-time messaging, and friend management. It exposes a RESTful API for the frontend client to interact with, ensuring secure and efficient data exchange.

Key functionalities include:

*   **User Management:** Handles user registration, login, profile updates, and authentication via both email/password and Google OAuth.
*   **Authentication & Authorization:** Implements session-based authentication using `express-session` and `passport.js` for secure access control to protected routes.
*   **Data Persistence:** Utilizes MongoDB through Mongoose for storing user data, messages, and friend relationships.
*   **Friend Management:** Manages sending, accepting, and rejecting friend requests, and maintaining a user's friend list.
*   **Real-time Communication:** (Inferred from `messageRoutes` and `socket.js` import) Facilitates real-time messaging capabilities, likely using WebSockets.

## Architecture

The backend follows a layered architecture, primarily consisting of an Express.js server interacting with a MongoDB database. It's designed to be a monolithic service, handling all core backend functionalities within a single application.

The application structure can be visualized as:



```mermaid
graph TD
    A[Client (Frontend)] --> B(Express.js Server);
    B --> C{Authentication & Middleware};
    C --> D[Routes];
    D --> E[Controllers];
    E --> F[Models];
    F --> G[MongoDB Database];
    B --> H(WebSocket Server);
    H -- Real-time Communication --> A;
```


*   **Client (Frontend):** Interacts with the backend via HTTP requests for API calls and WebSocket connections for real-time updates.
*   **Express.js Server:** The main application layer, handling HTTP requests, routing, and serving static assets in production.
*   **Authentication & Middleware:** A layer responsible for parsing cookies, JSON bodies, managing sessions, and protecting routes.
*   **Routes:** Defines the API endpoints and maps them to corresponding controller functions.
*   **Controllers:** Contains the business logic for handling requests, interacting with models, and sending responses.
*   **Models:** Mongoose schemas defining the structure and behavior of data stored in MongoDB.
*   **MongoDB Database:** The NoSQL database storing application data.
*   **WebSocket Server:** (Inferred) An integrated component, likely using Socket.IO, for real-time, bi-directional communication with clients.

## Technology Stack

The backend is built upon a robust JavaScript ecosystem, leveraging Node.js and key frameworks and libraries for efficient development and operation.

| Layer/Category       | Technology      | Purpose                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   The backend's primary duty is to manage all API requests and data logic. It orchestrate how data is stored (MongoDB), how users authenticate (Passport), and how real-time communication occurs (Socket.js, inferred). The central `index.js` file is responsible for setting up the Express app, connecting to the database, configuring middleware, and defining routes. This is the entry point for the backend server.
```javascript
// backend/src/index.js [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/index.js)
import express from "express";
import cors from "cors";
import authRoutes from "./routes/auth.route.js";
import messageRoutes from "./routes/message.route.js";
import friendRoutes from "./routes/friend.route.js";

import path from "path";

import dotenv from "dotenv";
import cookieParser from "cookie-parser";

import { connectDB } from "./lib/db.js";
import { app, server } from "./lib/socket.js";

import session from "express-session";
import passport from "passport";
import { configurePassport } from "./lib/passport.config.js";

const __dirname = path.resolve();
dotenv.config();

configurePassport();

app.use(cookieParser());
app.use(express.json({limit : '2mb'}));
app.use(express.urlencoded({ limit: '2mb', extended: true }));
app.use(cors({
    origin: "http://localhost:5173",
    credentials: true,
}));

app.use(session({
    secret: process.env.SESSION_SECRET, 
    resave: false,
    saveUninitialized: false, 
    cookie: {
        secure: process.env.NODE_ENV === "production", // true in production (HTTPS)
        httpOnly: true,
        maxAge: 7 * 24 * 60 * 60 * 1000 
    }
}));

app.use(passport.initialize());
app.use(passport.session());  

app.use("/api/auth", authRoutes );
app.use("/api/messages", messageRoutes );
app.use("/api/friends", friendRoutes);


const PORT = process.env.PORT;
if(process.env.NODE_ENV === "production"){
    app.use(express.static(path.join(__dirname, "../frontend/dist")));
    
    app.get("*" , (req, res) => {
        res.sendFile(path.join(__dirname,"../frontend", "dist","index.html"));
    })
}

server.listen(PORT, () => {
    console.log("server is running on PORT: " + String(PORT));
    connectDB();
});
```

### Database Connection
The `connectDB` function in `db.js` is responsible for establishing a connection to MongoDB using Mongoose. It logs successful connections or errors, which is crucial for monitoring the database status. Robust error handling ensures that connection issues are caught and reported, preventing application failures.

```javascript
// backend/src/lib/db.js [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/db.js)
import mongoose from "mongoose"

export const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI);
    console.log(`MongoDB connected:  ${conn.connection.host}`);
  }
  catch(error){
    console.log("MongoDB connection error: ", error);
  }
}
```

### User Data Model
The `User` model, defined in `user.model.js`, specifies the schema for user documents in MongoDB. It includes fields for authentication (email, username, password, authProvider, googleId) and social features (friends, friendRequests, sentRequests, profilePic). The `timestamps: true` option automatically adds `createdAt` and `updatedAt` fields, which are valuable for auditing and data management.

```javascript
// backend/src/models/user.model.js [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js)
import mongoose from "mongoose"

const  userSchema = new mongoose.Schema(
    {
        email: { 
            type: String,
            required: true,
            unique: true
        },
        username: {
            type: String,
            required: [true, "Username is required"],
            unique: true,
            trim: true,
            minlength: [3, "Username must be at least 3 characters long"],
            maxlength: [20, "Username cannot be more than 20 characters long"]
        }
        ,
        password: {
            type: String,
            minlength: 6,
        },
        profilePic: {
            type: String,
            default: "",
        },
        friends: [{
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: [] 
        }],
        friendRequests: [{ // Incoming friend requests
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: []
        }],
        sentRequests: [{ // Outgoing friend requests
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: []
        }],
        authProvider: {
            type: String,
            enum: ['email', 'google'],
            default: 'email'
        },
        googleId: {
            type: String,
            unique: true,
            sparse: true
        },
    },
    { 
        timestamps: true
    } 
);

userSchema.pre('save', async function(next) {
    if (this.authProvider === 'google' && !this.isModified('password')) {
        this.password = undefined;
    }
    if (this.authProvider === 'email' && !this.password && this.isNew) {
        return next(new Error('Password is required for email signup.'));
    }
    next();
});

const User = mongoose.model("User", userSchema);

export default User;
```
The `userSchema.pre('save')` hook demonstrates a best practice for handling different authentication providers. For Google authenticated users, the password field is explicitly undefined, ensuring sensitive information is not stored unnecessarily. For email-based sign-ups, it enforces that a password must be provided, preventing incomplete user profiles. The `sparse: true` on `googleId` allows multiple documents to not have a `googleId` value, but if they do, it must be unique. This is crucial for supporting both email and Google authentication concurrently.

## API Endpoints

The backend exposes several API routes, primarily for authentication, messaging, and friend management. These routes are organized logically using Express routers.

### Authentication Routes

The `auth.route.js` file defines endpoints for user authentication, registration, and profile management. It integrates `passport.js` for robust session-based authentication and Google OAuth.

```javascript
// backend/src/routes/auth.route.js [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/auth.route.js)
import express from "express"
import passport from 'passport';
import { login, logout, signup, updateProfile, checkAuth, googleAuthCallback, checkUsernameAvailability} from  "../controllers/auth.controller.js"
import { protectRoute } from "../middleware/auth.middleware.js"
const router = express.Router();

router.post("/signup", signup);

router.post("/login", login);

router.post("/logout", logout);

router.put("/update-profile", protectRoute ,updateProfile)

router.get("/username/check/:username", protectRoute, checkUsernameAvailability);

router.get("/check", protectRoute, checkAuth)

router.get(
    '/google',
    passport.authenticate('google', { scope: ['profile', 'email'] })
);
router.get(
    '/google/callback',
    passport.authenticate('google', {
        // successRedirect: 'http://localhost:5173/', 
        failureRedirect: 'http://localhost:5173/login', 
        failureMessage: true 
    }),
    googleAuthCallback 
);
export default router;
```

#### Authentication Flow (Signup, Login, Google OAuth)
This sequence diagram illustrates the user signup and login process, including the specific steps for Google OAuth authentication.



```mermaid
sequenceDiagram
    participant C as Client
    participant S as Server
    participant DB as MongoDB
    participant P as Passport.js
    participant G as Google OAuth

    C->>S: POST /api/auth/signup (username, email, password)
    S->>P: Call signup controller
    P->>DB: Check for existing user, create new user
    DB-->>P: User created/error
    P-->>S: Session established (if successful)
    S-->>C: 201 Created / 400 Error

    C->>S: POST /api/auth/login (email, password)
    S->>P: Call login controller
    P->>DB: Verify credentials
    DB-->>P: User found/not found
    P-->>S: Session established (if successful)
    S-->>C: 200 OK / 401 Unauthorized

    C->>S: GET /api/auth/google
    S->>G: Redirect to Google for authentication
    G-->>C: Google login page
    C->>G: User authenticates with Google
    G-->>S: Redirect with code (GET /api/auth/google/callback)
    S->>P: Passport.authenticate('google')
    P->>G: Exchange code for tokens
    G-->>P: Tokens received
    P->>DB: Find/Create user with Google ID
    DB-->>P: User data
    P-->>S: Session established
    S->>C: Redirect to success/failure URL
```



### Other Routes
*   **Message Routes (`/api/messages`):** Handles functionalities related to sending, receiving, and managing messages between users. This would typically involve controllers for creating new messages, fetching message history, and potentially managing real-time message updates via WebSockets.
*   **Friend Routes (`/api/friends`):** Manages social interactions, including sending friend requests, accepting/rejecting requests, and listing friends. This category of routes relies heavily on the `friends`, `friendRequests`, and `sentRequests` fields in the `User` model.

## Key Integration Points

*   **Authentication & Session Management:** The backend employs `express-session` for managing user sessions and `passport.js` for handling various authentication strategies (local for email/password, Google OAuth). This setup ensures that user sessions are persistent and secure, allowing authenticated access to protected resources. The `cookie-parser` middleware is vital for processing cookies containing session IDs.
*   **Database Interaction:** Mongoose provides an ODM (Object Data Modeling) layer over MongoDB, simplifying data interactions. The defined schemas and models are central to how data is structured, validated, and queried.
*   **CORS Configuration:** `cors` middleware is configured to allow requests from the frontend application (`http://localhost:5173`), enabling cross-origin resource sharing, which is standard in a decoupled frontend/backend architecture.
*   **Real-time Communication:** The inclusion of `socket.js` (and the `app`, `server` exports) strongly suggests that WebSockets, likely via Socket.IO, are integrated for real-time features like instant messaging. This is a crucial component for a chat application, providing low-latency updates without constant polling.
*   **Production Deployment:** The `if(process.env.NODE_ENV === "production")` block demonstrates a common pattern for serving static frontend assets directly from the backend in a production environment, simplifying deployment by co-locating the frontend build. This ensures that the entire application can be served from a single origin.

Next: [Authentication and Authorization](./2.1_authentication-authorization.mdx)