---
title: "API Endpoints and Controllers"
description: "Documentation for all REST API endpoints and their corresponding controller logic."
sidebar_position: 21
---
First, let's break this down into a structured plan:

1.  **Analyze Content for Structure:**
    *   **High-level explanations:** Describe the purpose of auth and message controllers/routes.
    *   **Bullets:** List key functionalities for each controller.
    *   **Tables:** Potentially for API endpoints and their methods/middleware.
    *   **Snippets:** Extract relevant code sections (signup, login, sendMessage, updateProfile, protectRoute).
    *   **Diagrams:**
        *   Mermaid 1: Authentication Flow (signup, login, google auth).
        *   Mermaid 2: Message Sending Flow (client to server to receiver).

2.  **Ensure 1-2 Mermaid Diagrams:**
    *   **Authentication Flow (graph TD):**
        *   Nodes: User, `POST /signup`, `POST /login`, `GET /google`, `GET /google/callback`, `Auth Controller`, `User Model`, `JWT Token`, `Frontend`.
        *   Edges: User --signup--> `POST /signup`, `POST /signup` --> `Auth Controller`, `Auth Controller` --> `User Model` (create), `Auth Controller` --> `JWT Token`, `JWT Token` --> `Frontend` (cookie). Similar for login. Google flow will involve `passport.authenticate` and `googleAuthCallback`.
    *   **Message Sending Flow (sequenceDiagram):**
        *   Participants: Client (Sender), `POST /send/:id`, `Message Controller`, `Cloudinary`, `Socket.io Server`, Client (Receiver).
        *   Sequence: Sender -> `POST /send/:id`, `POST /send/:id` -> `Message Controller`, `Message Controller` -> `Cloudinary` (if image), `Message Controller` -> `Message Model` (save), `Message Controller` -> `Socket.io Server` (emit), `Socket.io Server` -> Receiver.

3.  **Validate Mermaid Syntax (internal simulation):**
    *   Confirm all node text is in double quotes: `A["Node Text"]`.
    *   Confirm edge labels are `-->|"Label"|`.
    *   Ensure proper diagram types and arrow styles.

4.  **Draft MDX Content:**
    *   Frontmatter.
    *   Title and TOC.
    *   Introduction to API endpoints and controllers.
    *   **Auth Module:**
        *   Explanation of `auth.route.js` and `auth.controller.js`.
        *   Functionality: signup, login, logout, checkAuth, Google Auth, username availability, profile update.
        *   Snippets:
            *   `signup` controller logic (`backend/src/controllers/auth.controller.js`).
            *   `login` controller logic (`backend/src/controllers/auth.controller.js`).
            *   `updateProfile` controller logic (`backend/src/controllers/auth.controller.js`).
            *   `protectRoute` middleware usage (`backend/src/routes/auth.route.js`).
            *   `google/callback` route (`backend/src/routes/auth.route.js`).
        *   Mermaid: Authentication Flow.
    *   **Message Module:**
        *   Explanation of `message.route.js` and `message.controller.js`.
        *   Functionality: get users for sidebar, get messages, send message.
        *   Snippets:
            *   `sendMessage` controller logic (`backend/src/controllers/message.controller.js`).
            *   `getUsersForSidebar` (`backend/src/controllers/message.controller.js`).
        *   Mermaid: Message Sending Flow.
    *   Key Integration Points.
    *   Next link.

**(Self-correction during planning for Mermaid):**
*   The instruction for edge labels `C -.-> B: "Accesses socket from auth store"` is incorrect. It should be `C -.->|"Accesses socket from auth store"| B`. I will ensure this is corrected in the output.
*   All node text *must* be quoted. I will double-check this for every node in both diagrams.

---


---
title: "API Endpoints and Controllers"
description: "Documentation for all REST API endpoints and their corresponding controller logic."
sidebar_position: 21
---

# API Endpoints and Controllers

<TOC />

This section details the REST API endpoints and the underlying controller logic that powers the Chat-App backend. We'll explore the authentication, user management, and real-time messaging functionalities, examining the routes and their associated controller functions.

The API is built using Node.js with Express, leveraging MongoDB for data storage and various middleware for security and functionality.

## Authentication and User Management

The `auth` module handles all user authentication flows, including registration, login, logout, session management, and profile updates. It integrates with `bcryptjs` for password hashing, `jsonwebtoken` for token generation, and `passport` for Google OAuth.

### Auth Endpoints (`backend/src/routes/auth.route.js`)

These routes define the public and protected endpoints for user authentication and profile management.

| Method | Endpoint                       | Description                                       | Middleware        | Controller Function          |
| :----- | :----------------------------- | :------------------------------------------------ | :---------------- | :--------------------------- |
| `POST` | `/api/auth/signup`             | Registers a new user.                             | None              | `signup`                     |
| `POST` | `/api/auth/login`              | Authenticates a user and issues a JWT.            | None              | `login`                      |
| `POST` | `/api/auth/logout`             | Clears the JWT cookie to log out.                 | None              | `logout`                     |
| `PUT`  | `/api/auth/update-profile`     | Updates user profile information (pic, username). | `protectRoute`    | `updateProfile`              |
| `GET`  | `/api/auth/username/check/:username` | Checks username availability.                     | `protectRoute`    | `checkUsernameAvailability`  |
| `GET`  | `/api/auth/check`              | Checks if a user is authenticated.                | `protectRoute`    | `checkAuth`                  |
| `GET`  | `/api/auth/google`             | Initiates Google OAuth login flow.                | `passport.authenticate` | (Passport handles)           |
| `GET`  | `/api/auth/google/callback`    | Callback URL for Google OAuth.                    | `passport.authenticate` | `googleAuthCallback`         |

#### Snippet: Google OAuth Callback Route

This snippet from `backend/src/routes/auth.route.js` shows how the Google OAuth callback is handled, including `passport`'s authentication and a custom callback function.

```javascript
router.get(
    '/google/callback',
    passport.authenticate('google', {
        failureRedirect: 'http://localhost:5173/login',
        failureMessage: true // Allows passing failure messages
    }),
    googleAuthCallback
);
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/auth.route.js#L26-L32)

### Auth Controllers (`backend/src/controllers/auth.controller.js`)

The `auth.controller.js` file contains the core logic for all authentication and user-related operations.

#### `signup` Controller

Handles user registration, including input validation, password hashing, checking for existing users, and generating a JWT upon successful registration.

```javascript
export const signup = async (req, res) => {
    const {username, email, password} = req.body;
    try {
        if(!username || !email || !password) {
            return res.status(400).json({message: "Please fill in all fields."});
        }
        // ... (length and existing user checks) ...
        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        const newUser = new User({
            username,
            email,
            password: hashedPassword,
            authProvider: 'email'
        });
        if(newUser){
            generateToken(newUser._id, res); // Generate JWT
            await newUser.save();

            res.status(201).json({
                _id: newUser._id,
                username: newUser.username,
                email: newUser.email,
                profilePic: newUser.profilePic,
                authProvider: newUser.authProvider
            });
        } else {
            res.status(400).json({message: "Invalid user data."});
        }
    } catch (error) {
        console.log("Error in signup controller", error.message)
        res.status(500).json({message: "Something went wrong."});
    }
};
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/auth.controller.js#L8-L56)

#### `login` Controller

Manages user login by validating credentials, handling different authentication providers (email/password vs. Google), and issuing a JWT.

```javascript
export const login = async (req, res) => {
    const {email, password} = req.body;
    try {
        const user = await User.findOne({email});

        if(!user) {
            return res.status(400).json({message: "Invalid credentials."});
        }

        if(user.authProvider === 'google' && !user.password){
            return res.status(400).json({ message: "Please sign in with Google." });
        }

        const isPasswordCorrect = await bcrypt.compare(password, user.password);
        if(!isPasswordCorrect) {
            return res.status(400).json({message: "Invalid credentials."});
        }

        generateToken(user._id, res); // Generate JWT
        res.status(200).json({
            _id: user._id,
            username: user.username,
            email: user.email,
            profilePic: user.profilePic,
            authProvider: user.authProvider,
        });
    } catch (error) {
        console.log("Error in login controller", error.message);
        res.status(500).json({message: "Something went wrong."});
    }
};
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/auth.controller.js#L58-L89)

#### `updateProfile` Controller

Allows authenticated users to update their profile picture and username. It includes validation for username uniqueness and integrates with Cloudinary for image uploads.

```javascript
export const updateProfile = async (req, res) => {
    try {
        const { profilePic, username } = req.body;
        const userId = req.user._id;
        let userToUpdate = await User.findById(userId);

        if (!userToUpdate) { /* ... handle user not found ... */ }

        const fieldsToUpdate = {};
        let newUsername = username ? username.trim() : null;

        // Handle username update logic
        if (newUsername && newUsername !== userToUpdate.username) {
            // ... (username validation and uniqueness checks) ...
            fieldsToUpdate.username = newUsername;
        }

        // Handle profile picture update logic with Cloudinary
        if (profilePic) {
            const uploadResponse = await cloudinary.uploader.upload(profilePic);
            fieldsToUpdate.profilePic = uploadResponse.secure_url;
        }

        if (Object.keys(fieldsToUpdate).length === 0) { /* ... handle no changes ... */ }

        const updatedUser = await User.findByIdAndUpdate(userId, { $set: fieldsToUpdate }, { new: true });

        generateToken(updatedUser._id, res); // Re-issue token with potentially new data
        res.status(200).json(updatedUser);

    } catch (error) {
        console.error("Error in updateProfile controller", error.message);
        res.status(500).json({ message: "Internal Server Error while updating profile." });
    }
};
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/auth.controller.js#L210-L269)

### User Authentication Flow

The following diagram illustrates the various paths a user can take to authenticate with the application.





```mermaid
graph TD
    U["User"]
    FE["Frontend Application"]
    BE["Backend Server"]
    AC["Auth Controller"]
    UM["User Model (MongoDB)"]
    CLO["Cloudinary"]
    PASS["Passport.js (Google Strategy)"]

    U --> FE: "Initiates Auth"
    FE -->|POST /api/auth/signup| BE
    BE --> AC: "signup()"
    AC --> UM: "Check/Create User"
    UM --> AC: "User Data"
    AC -->|Generate JWT| BE
    BE -->|Set JWT Cookie| FE
    FE --> U: "Logged In (Email)"

    FE -->|POST /api/auth/login| BE
    BE --> AC: "login()"
    AC --> UM: "Find User & Compare Pass"
    UM --> AC: "User Data/Result"
    AC -->|Generate JWT| BE
    BE -->|Set JWT Cookie| FE
    FE --> U: "Logged In (Email)"

    FE -->|GET /api/auth/google| BE
    BE --> PASS: "Authenticate with Google"
    PASS -->|Redirect to Google| U
    U -->|Google Login Page| PASS
    PASS -->|Callback /api/auth/google/callback| BE
    BE -->|passport.authenticate()| PASS
    PASS --> AC: "googleAuthCallback()"
    AC -->|Generate JWT| BE
    BE -->|Set JWT Cookie & Redirect| FE
    FE --> U: "Logged In (Google)"

    U --> FE: "Profile Update"
    FE -->|PUT /api/auth/update-profile| BE
    BE -->|protectRoute| AC: "updateProfile()"
    AC --> CLO: "Upload Profile Pic (Optional)"
    CLO --> AC: "Image URL"
    AC --> UM: "Update User Data"
    UM --> AC: "Updated User"
    AC -->|Generate New JWT| BE
    BE -->|Set New JWT Cookie| FE
    FE --> U: "Profile Updated"
```



## Messaging Functionality

The `message` module manages all aspects of message exchange, including retrieving user lists, fetching conversation history, and sending new messages. It integrates with Cloudinary for image uploads and `socket.io` for real-time communication.

### Message Endpoints (`backend/src/routes/message.route.js`)

These endpoints facilitate communication between users.

| Method | Endpoint                    | Description                                       | Middleware     | Controller Function       |
| :----- | :-------------------------- | :------------------------------------------------ | :------------- | :------------------------ |
| `GET`  | `/api/messages/users`       | Retrieves a list of users for the sidebar (excluding self). | `protectRoute` | `getUsersForSidebar`      |
| `GET`  | `/api/messages/:id`         | Fetches messages between the logged-in user and a specific user (`:id`). | `protectRoute` | `getMessages`             |
| `POST` | `/api/messages/send/:id`    | Sends a new message to a specific user (`:id`). | `protectRoute` | `sendMessage`             |

#### Snippet: Message Routes Definition

This snippet from `backend/src/routes/message.route.js` showcases the protected message routes.

```javascript
router.get("/users", protectRoute, getUsersForSidebar);

router.get("/:id", protectRoute, getMessages);

router.post("/send/:id", protectRoute, sendMessage);
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/message.route.js#L7-L11)

### Message Controllers (`backend/src/controllers/message.controller.js`)

The `message.controller.js` file contains the logic for retrieving and sending messages.

#### `getUsersForSidebar` Controller

Retrieves a list of all users registered in the system, excluding the currently logged-in user. This is typically used to populate a chat sidebar.

```javascript
export const getUsersForSidebar = async (req, res) => {
    try {
        const loggedInUserId = req.user._id;
        const filteredUsers = await User.find({
            _id: { $ne: loggedInUserId }}).select("-password");
        res.status(200).json(filteredUsers);
    }
    catch (error) {
        console.log("Error in getUsersForSidebar: ", error);
        res.status(500).json({ error: "Internal Server Error" });
    }
};
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/message.controller.js#L9-L21)

#### `sendMessage` Controller

Handles the process of sending a new message. It supports both text and image messages, uploads images to Cloudinary, saves the message to the database, and uses Socket.io to emit the new message in real-time to the receiver.

```javascript
export const sendMessage = async (req, res) => {
    try {
        const { text, image } = req.body;
        const { id: receiverId } = req.params;
        const senderId = req.user._id;

        let imageUrl;
        if (image) {
            const uploadResponse = await cloudinary.uploader.upload(image);
            imageUrl = uploadResponse.secure_url;
        }
        const newMessage = new Message({
            senderId,
            receiverId,
            text,
            image: imageUrl,
        });

        await newMessage.save();

        const receiverSocketId = getReceiverSocketId(receiverId);

        if(receiverSocketId) {
            io.to(receiverSocketId).emit("newMessage", newMessage); // Real-time delivery
        }

        res.status(201).json(newMessage);

    } catch (error) {
        console.log("Error in sendMessage controller:  ", error);
        res.status(500).json({ error: "Internal Server Error" });
    }
};
```

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/message.controller.js#L47-L79)

### Real-time Message Sending Flow

This sequence diagram illustrates how messages are sent, including optional image upload and real-time delivery via Socket.io.





```mermaid
sequenceDiagram
    participant CS as "Client (Sender)"
    participant BE as "Backend Server"
    participant MC as "Message Controller"
    participant CLO as "Cloudinary"
    participant MMS as "Message Model (MongoDB)"
    participant SIS as "Socket.io Server"
    participant CR as "Client (Receiver)"

    CS->>+BE: "POST /api/messages/send/:id with {text, image}"
    BE->>MC: "sendMessage(req, res)"
    alt Image included
        MC->>+CLO: "Upload Image"
        CLO-->>-MC: "Image URL"
    end
    MC->>MMS: "Create & Save new Message"
    MMS-->>MC: "Saved Message Object"
    MC->>SIS: "getReceiverSocketId(receiverId)"
    SIS-->>MC: "Receiver Socket ID (if online)"
    alt Receiver is online
        MC->>+SIS: "Emit 'newMessage' to receiverSocketId"
        SIS->>CR: "newMessage event"
        CR-->>-SIS: "Acknowledges receipt"
    end
    MC-->>-BE: "Success Response (201)"
    BE-->>CS: "New Message JSON"
```



## Key Integration Points

*   **Middleware for Protection:** The `protectRoute` middleware is crucial for securing endpoints. It ensures that only authenticated users can access certain routes, providing robust access control.
    ```javascript
    // Example from auth.route.js showing protectRoute usage
    router.put("/update-profile", protectRoute ,updateProfile)
    router.get("/username/check/:username", protectRoute, checkUsernameAvailability);
    ```
    [View `protectRoute` usage](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/auth.route.js#L14-L17)
*   **JWT for Session Management:** A JSON Web Token (JWT) is generated upon successful login/signup (or Google OAuth) and set as an HTTP-only cookie. This token is then used by `protectRoute` to authenticate subsequent requests.
*   **Cloudinary for Media Uploads:** Both profile picture updates (`updateProfile`) and image messages (`sendMessage`) leverage Cloudinary for secure and scalable image storage.
*   **Socket.io for Real-time Communication:** The `sendMessage` controller integrates directly with the Socket.io server to instantly notify the receiving user of new messages, enabling a real-time chat experience without needing to poll the API.
*   **Google OAuth with Passport.js:** The application seamlessly integrates Google as an authentication provider, allowing users to sign up or log in using their Google accounts, enhancing user experience and security.

These integrations are fundamental to the application's functionality, ensuring a secure, real-time, and user-friendly experience.

Next: [Data Models and Schema](./2.2_data-models-and-schema.mdx)
```