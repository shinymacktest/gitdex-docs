---
title: "Backend Data Models"
description: "Description of the database schema and models."
---

# Backend Data Models

<TOC />

This document details the data models used in the backend of the application.  These models define the structure of the data stored in the MongoDB database.  We utilize Mongoose, an Object Data Modeling (ODM) library for MongoDB and Node.js, to interact with the database.

## User Model

The `User` model represents individual users within the application. It includes fields for user authentication, profile information, and social connections.

### Schema Definition

The core of the `User` model is defined by the `userSchema`.

```javascript
import mongoose from "mongoose"

const  userSchema = new mongoose.Schema(
    {
        email: { 
            type: String,
            required: true,
            unique: true
        },
        username: {
            type: String,
            required: [true, "Username is required"],
            unique: true,
            trim: true,
            minlength: [3, "Username must be at least 3 characters long"],
            maxlength: [20, "Username cannot be more than 20 characters long"]
        }
        ,
        password: {
            type: String,
            minlength: 6,
        },
        profilePic: {
            type: String,
            default: "",
        },
        friends: [{
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: [] 
        }],
        friendRequests: [{ 
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: []
        }],
        sentRequests: [{ 
            type: mongoose.Schema.Types.ObjectId,
            ref: "User",
            default: []
        }],
        authProvider: {
            type: String,
            enum: ['email', 'google'],
            default: 'email'
        },
        googleId: {
            type: String,
            unique: true,
            sparse: true
        },
    },
    { 
        timestamps: true
    } 
);

// ... (Pre-save middleware omitted for brevity)

const User = mongoose.model("User", userSchema);

export default User;
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js)

*   **`email`**:  A required, unique string representing the user's email address.
*   **`username`**: A required, unique string representing the user's username.  Validation enforces a minimum length of 3 and a maximum of 20 characters.
*   **`password`**: A string representing the user's password. Minimum length is 6 characters.  This field is handled differently based on the `authProvider`.
*   **`profilePic`**: A string storing the URL of the user's profile picture. Defaults to an empty string.
*   **`friends`**: An array of `ObjectId`s referencing other `User` documents, representing the user's friends.
*   **`friendRequests`**: An array of `ObjectId`s referencing other `User` documents, representing incoming friend requests.
*   **`sentRequests`**: An array of `ObjectId`s referencing other `User` documents, representing outgoing friend requests.
*   **`authProvider`**:  Specifies the authentication method used (`email` or `google`).
*   **`googleId`**:  Stores the Google ID if the user authenticated with Google.  `unique: true, sparse: true` allows for unique Google IDs while accommodating users who haven't authenticated with Google.
*   **`timestamps`**: Automatically adds `createdAt` and `updatedAt` timestamps.

### Pre-save Middleware

The `userSchema` includes pre-save middleware to handle password management for different authentication providers.

```javascript
userSchema.pre('save', async function(next) {
    if (this.authProvider === 'google' && !this.isModified('password')) {
        this.password = undefined;
    }
    if (this.authProvider === 'email' && !this.password && this.isNew) {
        return next(new Error('Password is required for email signup.'));
    }
    next();
});
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js)

This middleware ensures that:

*   If a user signs up with Google, the password field is set to `undefined` to avoid storing unnecessary data.
*   If a user signs up with email and doesn't provide a password, an error is thrown.


## Message Model

The `Message` model represents individual messages exchanged between users.

### Schema Definition

```javascript
import express from "express";
import mongoose from "mongoose";

const messageSchema = new mongoose.Schema(
    {
     senderId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     receiverId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     text: {
        type: String,
     },
     image: {
        type: String,
     },
    },
    {timestamps: true}
);

export default mongoose.model("Message", messageSchema);
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/message.model.js)

*   **`senderId`**: An `ObjectId` referencing the `User` who sent the message.
*   **`receiverId`**: An `ObjectId` referencing the `User` who received the message.
*   **`text`**:  The text content of the message.
*   **`image`**: A string representing the URL of an image included in the message (optional).
*   **`timestamps`**: Automatically adds `createdAt` and `updatedAt` timestamps.


## Data Model Relationships

The `User` and `Message` models are related through the `senderId` and `receiverId` fields in the `Message` model, which reference the `_id` field of the `User` model. This creates a many-to-many relationship between users and messages, meaning a user can send and receive many messages.

````mermaid
classDiagram
    class User {
        -email : String
        -username : String
        -password : String
        -profilePic : String
        -friends : [ObjectId]
        -friendRequests : [ObjectId]
        -sentRequests : [ObjectId]
        -authProvider : String
        -googleId : String
    }
    class Message {
        -senderId : ObjectId
        -receiverId : ObjectId
        -text : String
        -image : String
    }
    User "1" -- "*" Message : sends
    User "1" -- "*" Message : receives
```

````mermaid
graph TD
    A[User Model] --> B(User Schema);
    B --> C{email, username, password,...};
    A --> D(User Instance);
    E[Message Model] --> F(Message Schema);
    F --> G{senderId, receiverId, text, image};
    E --> H(Message Instance);
    D --> G;
    H --> C;

```


Next: [Frontend Development](./3_frontend.mdx)