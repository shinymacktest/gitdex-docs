---
title: "Backend Core & Setup"
description: "Understanding the server's foundation, database, and essential utilities for the Chat App backend."
---
<TOC />

# Backend Core & Setup

This section details the foundational components of the application's backend, including the main server entry point, database connection, and external service integrations.

## Server Entry Point (`index.js`)

The `index.js` file serves as the main entry point for the Express.js server. It's responsible for configuring middleware, defining API routes, connecting to the database, and starting the server, including WebSocket capabilities.

```javascript
// backend/src/index.js
import express from "express";
import cors from "cors";
import authRoutes from "./routes/auth.route.js";
import messageRoutes from "./routes/message.route.js";
import friendRoutes from "./routes/friend.route.js";
// ... other imports ...
import { connectDB } from "./lib/db.js";
import { app, server } from "./lib/socket.js";
import { configurePassport } from "./lib/passport.config.js";

// ... Configuration and Middleware setup ...

app.use("/api/auth", authRoutes );
app.use("/api/messages", messageRoutes );
app.use("/api/friends", friendRoutes);

server.listen(PORT, () => {
    console.log("server is running on PORT: " + String(PORT));
    connectDB();
});
```
[Source: `backend/src/index.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/index.js)

### Middleware Configuration

The server configures several Express middleware to handle various aspects of incoming requests:

*   **`cookieParser()`**: Parses cookies attached to the client request.
*   **`express.json({limit : '2mb'})`**: Parses incoming requests with JSON payloads. The `limit` option prevents excessively large JSON bodies.
*   **`express.urlencoded({ limit: '2mb', extended: true })`**: Parses incoming requests with URL-encoded payloads.
*   **`cors()`**: Enables Cross-Origin Resource Sharing, allowing the frontend to make requests to the backend from a different origin. It's configured to accept requests from `http://localhost:5173` with credentials.
*   **`session()`**: Configures `express-session` for session management, crucial for maintaining user state across requests, especially for authentication.
*   **`passport.initialize()`** & **`passport.session()`**: Integrates Passport.js for authentication, allowing users to log in and maintain authenticated sessions.

### API Routes

The server defines three main API route groups, each handled by a dedicated router:

*   `/api/auth`: Handles user authentication related endpoints (e.g., login, logout, Google OAuth).
*   `/api/messages`: Manages message-related operations (e.g., sending, retrieving messages).
*   `/api/friends`: Handles friend management functionalities (e.g., sending requests, accepting, rejecting, removing friends).

### Application Flow & Integrations

The `index.js` file orchestrates the backend's core functionalities:

````mermaid
graph TD
    A[Client Request] --> B{Express App}
    B -- Middleware Chain --> C(CORS Check)
    C --> D(Cookie Parsing)
    D --> E(Body Parsing: JSON/URL-encoded)
    E --> F(Session Management)
    F --> G(Passport.js Init & Session)
    G --> H{API Routers}
    H --> I[Authentication Routes]
    H --> J[Message Routes]
    H --> K[Friend Routes]
    I,J,K --> L(Controllers)
    L --> M[MongoDB (via Mongoose)]
    L --> N[Cloudinary (for uploads)]
    J --> O[Socket.io (Real-time updates)]

    subgraph Server Startup
        P[server.listen(PORT)] --> B
        Q[connectDB()] --> M
        R[configurePassport()] --> G
    end
```
<!-- Fixed Mermaid syntax -->

## Database Connection (`lib/db.js`)

The `lib/db.js` file provides a simple utility function, `connectDB`, to establish a connection to MongoDB using Mongoose. It logs the connection status or any errors encountered during the process.

```javascript
// backend/src/lib/db.js
import mongoose from "mongoose"

export const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI);
    console.log(`MongoDB connected:  ${conn.connection.host}`);
  }
  catch(error){
    console.log("MongoDB connection error: ", error);
  }
}
```
[Source: `backend/src/lib/db.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/db.js)

This function is called once the server starts, ensuring the database is accessible for all subsequent operations.

## Cloudinary Integration (`lib/cloudinary.js`)

The `lib/cloudinary.js` file configures the Cloudinary API for media asset management. This service is primarily used for uploading and storing images sent as part of messages.

```javascript
// backend/src/lib/cloudinary.js
import {v2 as cloudinary} from "cloudinary"
import { config } from 'dotenv'

config(); // Load environment variables

cloudinary.config(
    {cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,}
);

export default cloudinary;
```
[Source: `backend/src/lib/cloudinary.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/cloudinary.js)

It uses environment variables for secure access to the Cloudinary account credentials. The `cloudinary` instance is then exported for use in other parts of the application, such as the message controller.

Next: [Authentication with Google OAuth](2_authentication.mdx)