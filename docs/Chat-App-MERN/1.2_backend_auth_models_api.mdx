---
title: "Backend Authentication, Data Models & API"
description: "Comprehensive guide to backend authentication middleware, Mongoose data models for User and Message, and the defined API routes for user management, friends, and messaging."
---
<TOC />

# Backend Authentication, Data Models & API

This section delves into the authentication mechanisms, the structure of data models, and the API endpoints that power the backend of the chat application.

## Authentication Middleware

The `protectRoute` middleware ensures that only authenticated users can access specific API endpoints. It verifies the presence and validity of a JWT token sent in the request cookies.

```javascript
import jwt from "jsonwebtoken"
import User from "../models/user.model.js"

export const protectRoute = async (req, res, next) => {
    try {
        const token = req.cookies.jwt;
        if(!token){ /* ... */ } // No token
        const decoded = jwt.verify(token, process.env.JWT_SECRET)
        if(!decoded) { /* ... */ } // Invalid token
        const user = await User.findById(decoded.userId).select("-password");
        if(!user) { /* ... */ } // User not found
        req.user = user; // Attach user object to request
        next(); // Proceed to next middleware/route handler
    } catch (error) {
        console.log("Error in protectRoute middleware", error.message);
        res.status(500).json({message: "Internal Server Error"});
    }
};
```
[Source: backend/src/middleware/auth.middleware.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/middleware/auth.middleware.js)

The middleware performs several critical steps:
1.  **Token Retrieval**: Extracts the JWT from the `jwt` cookie.
2.  **Token Verification**: Decodes and verifies the token using the `JWT_SECRET`.
3.  **User Lookup**: Finds the associated user in the database, excluding their password.
4.  **Attach User**: If valid, attaches the `user` object to the `req` object for subsequent route handlers.
5.  **Error Handling**: Catches various authentication failures (no token, invalid token, user not found) and returns appropriate HTTP status codes.

<!-- Fixed Mermaid syntax -->
````mermaid
sequenceDiagram
    participant C as Client
    participant M as protectRoute Middleware
    participant D as Database

    C->>M: API Request (with JWT cookie)
    M->>M: Check for JWT in cookies
    alt No JWT
        M-->>C: 401 Unauthorized (No Token)
    else JWT present
        M->>M: Verify JWT with SECRET
        alt Invalid JWT
            M-->>C: 401 Unauthorized (Invalid Token)
        else Valid JWT
            M->>D: Find User by ID (from JWT)
            D-->>M: User data (excluding password)
            alt User not found
                M-->>C: 404 Not Found (User)
            else User found
                M->>M: Attach User to req.user
                M-->>C: Continue to next handler
            end
        end
    end
```

## Data Models

The application defines two primary Mongoose schemas: `User` and `Message`.

### User Model
The `User` schema stores comprehensive user information, including authentication details, profile data, and relationships with other users (friends, friend requests).

```javascript
import mongoose from "mongoose"

const userSchema = new mongoose.Schema(
    {
        email: { type: String, required: true, unique: true },
        username: { /* ... */ },
        password: { type: String, minlength: 6 },
        profilePic: { type: String, default: "" },
        friends: [{ type: mongoose.Schema.Types.ObjectId, ref: "User", default: [] }],
        friendRequests: [{ /* ... */ }], // Incoming
        sentRequests: [{ /* ... */ }], // Outgoing
        authProvider: { type: String, enum: ['email', 'google'], default: 'email' },
        googleId: { type: String, unique: true, sparse: true },
    },
    { timestamps: true }
);

userSchema.pre('save', async function(next) {
    if (this.authProvider === 'google' && !this.isModified('password')) {
        this.password = undefined; // No password for Google auth
    }
    // ... password required for email signup logic
    next();
});

const User = mongoose.model("User", userSchema);
export default User;
```
[Source: backend/src/models/user.model.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js)

Key features:
*   **Authentication Diversity**: Supports both email/password and Google OAuth, managed by the `authProvider` and `googleId` fields.
*   **Social Features**: `friends`, `friendRequests`, and `sentRequests` arrays enable robust friend management.
*   **Pre-save Hook**: A `pre('save')` hook intelligently handles password requirements based on the `authProvider`, ensuring data integrity.

<!-- Fixed Mermaid syntax -->
````mermaid
classDiagram
    class User {
        +String email
        +String username
        -String password
        +String profilePic
        +ObjectId[] friends
        +ObjectId[] friendRequests
        +ObjectId[] sentRequests
        +String authProvider
        +String googleId
        +timestamps: Boolean
        +save()
    }
    User "1" *-- "0..*" User : friends
    User "1" *-- "0..*" User : friendRequests
    User "1" *-- "0..*" User : sentRequests
```

### Message Model
The `Message` schema defines the structure for individual chat messages.

```javascript
import mongoose from "mongoose";

const messageSchema = new mongoose.Schema(
    {
     senderId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     receiverId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     text: {
        type: String,
     },
     image: {
        type: String,
     },
    },
    {timestamps: true}
);

export default mongoose.model("Message", messageSchema);
```
[Source: backend/src/models/message.model.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/message.model.js)

Messages link to `User` models via `senderId` and `receiverId`, allowing for conversational context. Messages can contain either `text` or an `image` URL.

## API Routes

The backend exposes several API routes for different functionalities, organized into `auth`, `friend`, and `message` categories. All routes requiring user authentication utilize the `protectRoute` middleware.

### Authentication Routes (`auth.route.js`)
Handles user registration, login, logout, profile updates, and Google OAuth.

```javascript
router.post("/signup", signup);
router.post("/login", login);
router.post("/logout", logout);
router.put("/update-profile", protectRoute ,updateProfile);
router.get("/username/check/:username", protectRoute, checkUsernameAvailability);
router.get("/check", protectRoute, checkAuth);
router.get('/google', passport.authenticate('google', { scope: ['profile', 'email'] }));
router.get('/google/callback', passport.authenticate('google', { /* ... */ }), googleAuthCallback);
```
[Source: backend/src/routes/auth.route.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/auth.route.js)

### Friend Management Routes (`friend.route.js`)
Manages friend requests and friend lists, with all routes protected by `protectRoute`.

```javascript
router.use(protectRoute); // All friend routes are protected
router.post("/request/send/", sendFriendRequest);
router.post("/request/accept/:senderId", acceptFriendRequest);
router.post("/request/reject/:senderId", rejectFriendRequest);
router.delete("/remove/:friendId", removeFriend);
router.get("/list", getFriends);
router.get("/requests/pending", getPendingRequests);
router.get("/requests/sent", getSentRequests);
```
[Source: backend/src/routes/friend.route.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/friend.route.js)

### Message Routes (`message.route.js`)
Handles fetching users for the sidebar, retrieving messages in a conversation, and sending new messages. All routes are protected.

```javascript
router.get("/users", protectRoute, getUsersForSidebar);
router.get("/:id", protectRoute, getMessages);
router.post("/send/:id", protectRoute, sendMessage);
```
[Source: backend/src/routes/message.route.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/message.route.js)

Next: [Frontend Overview & Core](/docs/2.1_frontend_overview_core)