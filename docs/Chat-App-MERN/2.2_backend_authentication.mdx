---
title: "Backend Authentication"
description: "Comprehensive guide to user authentication endpoints including signup, login, logout, Google OAuth, and profile management."
---
<TOC />

# Backend Authentication

The `auth.controller.js` file is responsible for managing all user authentication and authorization logic on the backend. It defines several asynchronous functions that handle user registration, login, logout, profile updates, and username availability checks.

## Core Authentication Controller Functions

The controller utilizes `bcryptjs` for password hashing, `jsonwebtoken` (via `generateToken` utility) for JWT creation, and interacts with the `User` Mongoose model for database operations. It also integrates `cloudinary` for profile picture uploads and `passport` for Google OAuth.

[Source: backend/src/controllers/auth.controller.js](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/controllers/auth.controller.js)

### 1. User Signup (`signup`)

This function handles the registration of new users.

**Process Flow:**
1.  **Input Validation**: Checks for the presence of `username`, `email`, and `password`. Enforces minimum/maximum length constraints for username (3-20 chars) and password (min 6 chars).
2.  **Existing User Check**: Verifies if the email or username is already registered.
3.  **Password Hashing**: If valid, generates a salt and hashes the password using `bcryptjs`.
4.  **User Creation**: Creates a new `User` instance with the provided details, including the hashed password and `authProvider: 'email'`.
5.  **Token Generation**: Generates a JWT token for the newly registered user and sets it as an HTTP-only cookie.
6.  **Response**: Saves the user to the database and responds with the new user's public details (excluding password).

```javascript
export const signup = async (req, res) => {
    const {username, email, password} = req.body;
    // ... validation and existing user checks ...
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);
    const newUser = new User({
        username,
        email,
        password: hashedPassword,
        authProvider: 'email'
    });
    if(newUser){
        generateToken(newUser._id, res);
        await newUser.save();
        res.status(201).json({ /* user data */ });
    } // ... error handling ...
};
```

#### Signup Sequence Diagram

````mermaid
sequenceDiagram
    participant C as Client
    participant B as Backend
    participant DB as MongoDB
    C->>B: POST /api/auth/signup {username, email, password}
    B->>B: Validate input
    B->>DB: Check for existing email/username
    DB-->>B: User exists? (No)
    B->>B: Hash password (bcryptjs)
    B->>DB: Save new user
    DB-->>B: New user saved
    B->>B: Generate JWT (generateToken)
    B-->>C: Set JWT cookie & 201 Created {user_data}
```

### 2. User Login (`login`)

This function authenticates existing users.

**Process Flow:**
1.  **Input**: Receives `email` and `password`.
2.  **User Lookup**: Finds the user by `email`.
3.  **Credential Check**:
    *   If no user found, returns "Invalid credentials".
    *   If the user signed up via Google (and has no password), prompts for Google sign-in.
    *   Compares the provided password with the stored hashed password using `bcrypt.compare()`.
4.  **Token Generation**: If credentials are correct, generates a JWT token and sets it as an HTTP-only cookie.
5.  **Response**: Responds with the authenticated user's public details.

```javascript
export const login = async (req, res) => {
    const {email, password} = req.body;
    // ... validation ...
    const user = await User.findOne({email});
    if(!user || (user.authProvider === 'google' && !user.password)){
        return res.status(400).json({message: "Invalid credentials or sign in with Google."});
    }
    const isPasswordCorrect = await bcrypt.compare(password, user.password);
    if(!isPasswordCorrect) { /* ... */ }
    generateToken(user._id, res);
    res.status(200).json({ /* user data */ });
};
```

### 3. User Logout (`logout`)

Handles user logout by clearing the JWT cookie.

```javascript
export const logout = (req, res) => {
    res.cookie("jwt", "", {maxAge: 0});
    res.status(200).json({message: "Logged out successfully."});
};
```

### 4. Check Authentication Status (`checkAuth`)

Verifies the user's authentication status based on the active session/token. Assumes a preceding middleware has populated `req.user`.

```javascript
export const checkAuth = (req, res) => {
    res.status(200).json({
        _id: req.user._id,
        username: req.user.username,
        email: req.user.email,
        profilePic: req.user.profilePic,
        authProvider: req.user.authProvider,
        createdAt: req.user.createdAt
    });
};
```

### 5. Google OAuth Callback (`googleAuthCallback`)

Handles the callback after a successful Google authentication.

**Process Flow:**
1.  **User Check**: Verifies if `req.user` is populated by Passport.
2.  **Token Generation**: Generates a JWT for the Google-authenticated user.
3.  **Redirection**: Redirects the user to the frontend application, potentially with an error if authentication failed.

```javascript
export const googleAuthCallback = async (req, res) => {
    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';
    if (!req.user) {
        return res.redirect(`${frontendUrl}/login?error=google_auth_failed`);
    }
    generateToken(req.user._id, res);
    res.redirect(frontendUrl);
};
```

### 6. Check Username Availability (`checkUsernameAvailability`)

Checks if a given username is available for a new user or for an existing user changing their username.

**Process Flow:**
1.  **Input Validation**: Validates username length (3-20 characters).
2.  **Current User Check**: If the username is the current user's existing username, it's considered available.
3.  **Database Check**: Queries the database for any existing user with the provided username (excluding the current user's ID if applicable).
4.  **Response**: Returns `available: true` or `false` with a descriptive message.

```javascript
export const checkUsernameAvailability = async (req, res) => {
    const { username } = req.params;
    const currentUserId = req.user._id;

    // ... validation ...
    if (req.user.username === username) {
        return res.status(200).json({ available: true, message: "This is your current username." });
    }
    const existingUser = await User.findOne({ username: username });
    if (existingUser) {
        return res.status(200).json({ available: false, message: "Username is already taken." });
    }
    res.status(200).json({ available: true, message: "Username is available." });
};
```

### 7. Update User Profile (`updateProfile`)

Allows authenticated users to update their profile information, such as `profilePic` and `username`.

**Process Flow:**
1.  **Input**: Receives `profilePic` (e.g., base64 string) and/or `username`.
2.  **User Lookup**: Finds the user by `userId` from `req.user`.
3.  **Username Update**:
    *   If a new username is provided and it's different from the current one, validates its length.
    *   Checks for username uniqueness across other users in the database.
4.  **Profile Picture Update**: If `profilePic` is provided, uploads it to Cloudinary and stores the `secure_url`.
5.  **Database Update**: Updates the user document in MongoDB with the new details.
6.  **Token Refresh**: Re-generates and sets a new JWT token to reflect any changes in user data that might be embedded in the token (e.g., username).
7.  **Response**: Returns the updated user object.

```javascript
export const updateProfile = async (req, res) => {
    const { profilePic, username } = req.body;
    const userId = req.user._id;
    let userToUpdate = await User.findById(userId);

    const fieldsToUpdate = {};
    // ... username validation and uniqueness check ...
    if (username && username.trim() !== userToUpdate.username) {
        fieldsToUpdate.username = username.trim();
    }

    if (profilePic) {
        const uploadResponse = await cloudinary.uploader.upload(profilePic);
        fieldsToUpdate.profilePic = uploadResponse.secure_url;
    }

    if (Object.keys(fieldsToUpdate).length === 0) {
        return res.status(400).json({ message: "No changes provided to update." });
    }

    const updatedUser = await User.findByIdAndUpdate(userId, { $set: fieldsToUpdate }, { new: true });
    generateToken(updatedUser._id, res); // Refresh token
    res.status(200).json(updatedUser);
};
```

This concludes the detailed explanation of the backend authentication mechanisms.

GLOBAL_TOC_PLACEHOLDER: 1. Overview, 2. Backend > 2.1. Backend Setup & Dependencies, 2.2. User Authentication