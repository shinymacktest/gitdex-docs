---
title: "State Management and Utilities"
description: "Explanation of how global state is managed using Zustand, and common frontend utility functions."
sidebar_position: 33
---
 # State Management and Utilities

This document explains the core mechanisms for managing global application state using Zustand and outlines essential utility functions within the frontend. Effective state management ensures a consistent user experience, while well-defined utilities promote code reusability and maintainability.

## Global State Management with Zustand

Zustand is a lightweight, fast, and scalable state-management solution for React. It offers a simple API to create stores and consume state in functional components without the boilerplate associated with other state management libraries. The application leverages two primary Zustand stores: `useAuthStore` for authentication-related state and `useChatStore` for chat and friend-related data.

### Authentication State (`useAuthStore`)

The `useAuthStore` manages all aspects related to user authentication, including the authenticated user's data, online status, and Socket.IO connection. It integrates directly with the backend API via `axiosInstance` for authentication actions and handles real-time online user updates through Socket.IO.

```javascript
// frontend/src/store/useAuthStore.js
import { create } from "zustand";
import { axiosInstance } from "../lib/axios";
import toast from "react-hot-toast";
import { io } from "socket.io-client";

const BASE_URL = import.meta.env.MODE == "development" ? "http://localhost:5001": "/";

export const useAuthStore = create((set, get) => ({
    authUser: null,
    isSigningUp: false,
    isLoggingIn: false,
    isUpdatingProfile: false,
    isCheckingAuth: true,
    onlineUsers: [],
    socket: null,

    // ... (other methods)
}));
```
This snippet demonstrates the initial setup of the `useAuthStore` using `create` from Zustand. It defines the initial state variables like `authUser`, various loading flags (`isSigningUp`, `isLoggingIn`), `onlineUsers`, and the `socket` instance for real-time communication. The `get()` function within the store allows access to the current state and other actions defined in the same store.

[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/store/useAuthStore.js#L1-L24)

#### Authentication Flows

The `useAuthStore` encapsulates several key authentication workflows:

-   **`checkAuth`**: Verifies the current user's authentication status with the backend on application load. If authenticated, it fetches user data and initiates the Socket.IO connection.

    ```javascript
    // frontend/src/store/useAuthStore.js
    // ...
    checkAuth: async () => {
        try {
            const res = await axiosInstance.get("/auth/check");
            set({ authUser: res.data });
            get().connectSocket(); // Connects socket upon successful auth
        } catch (error) {
            set({ authUser: null });
            console.log("Error in checkAuth: ", error);
        } finally {
            set({ isCheckingAuth: false });
        }
    },
    // ...
    ```
    This method is crucial for persistent login. It queries the `/auth/check` endpoint, updating the `authUser` state and then calling `connectSocket` to establish a real-time connection.
    [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/store/useAuthStore.js#L26-L38)

-   **`signup`, `login`, `logout`, `updateProfile`**: These methods handle user registration, session management, and profile updates, integrating with `axiosInstance` for API calls and providing user feedback via `react-hot-toast`. Each method updates the `authUser` state accordingly and manages loading indicators.
-   **`connectSocket` and `disconnectSocket`**: Manage the lifecycle of the Socket.IO connection, ensuring that users are connected to the real-time server only when authenticated and their `userId` is passed as a query parameter. The socket listens for `getOnlineUsers` events to update the `onlineUsers` state.

    ```javascript
    // frontend/src/store/useAuthStore.js
    // ...
    connectSocket: () => {
        const { authUser } = get();
        if(!authUser || get().socket?.connected) return;

        const socket = io(BASE_URL, {
            query: {
                userId : authUser._id,
            },
        });
        socket.connect();
        set({socket: socket});

        socket.on("getOnlineUsers", (userIds) => {
            set({onlineUsers: userIds})
        }); 

    },

    disconnectSocket : () => {
        if(get().socket?.connected) get().socket.disconnect();
    }
    // ...
    ```
    This snippet details the `connectSocket` logic, which initializes a Socket.IO client, passes the `userId` for identification, and sets up an event listener for `getOnlineUsers` to track active users.
    [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/store/useAuthStore.js#L107-L125)

#### Authentication Flow




```mermaid
graph TD
    A["Application Start"] --> B{ "Is User Authenticated?" }
    B -- "No" --> C["Prompt Login/Signup"]
    B -- "Yes (checkAuth)" --> D["Fetch Auth User Data"]
    D --> E["Set authUser State"]
    E --> F["Connect Socket.IO"]
    F --> G["Listen for 'getOnlineUsers'"]
    G --> H["Update onlineUsers State"]
    C --> I["User Logs In/Signs Up"]
    I --> J["API Call (Login/Signup)"]
    J --> D;
    K["User Logs Out"] --> L["API Call (Logout)"]
    L --> M["Clear authUser State"]
    M --> N["Disconnect Socket.IO"]
```



### Chat and Friends State (`useChatStore`)

The `useChatStore` manages all data related to chat functionalities, including messages, user lists (friends), and friend requests. It also handles the selection of a specific chat partner.

```javascript
// frontend/src/store/useChatStore.js
import toast from "react-hot-toast";
import { create } from "zustand";
import { axiosInstance } from "../lib/axios";
import { useAuthStore } from "./useAuthStore";


export const useChatStore = create((set, get) => ({
    messages:[],
    users: [],
    pendingRequests: [],
    sentRequests: [],
    selectedUser: null,
    isUsersLoading: false,
    isMessagesLoading: false,
    isFriendBoxOpen: false,

    // ... (other methods)
}));
```
This store holds arrays for `messages`, `users` (friends), `pendingRequests`, and `sentRequests`. It also tracks the `selectedUser` for the current chat and various loading states.
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/store/useChatStore.js#L1-L18)

#### Chat and Friend Management Actions

-   **`getFriends`, `getPendingRequests`, `getSentRequests`**: Fetch respective lists from the backend using `axiosInstance` and update the store's state.
-   **`sendFriendRequest`, `acceptFriendRequest`, `rejectFriendRequest`, `removeFriend`**: Interact with the backend API to manage friend relationships. Upon success, these actions typically trigger a refresh of relevant lists to ensure UI consistency.
-   **`getMessages`, `sendMessage`**: Handle fetching historical messages for a `selectedUser` and sending new messages. The `sendMessage` action optimistically updates the `messages` array before receiving a response from the server.
-   **`subscribeToMessages`, `unsubscribeFromMessages`**: These methods tie into the Socket.IO instance managed by `useAuthStore`. They listen for `newMessage` events to dynamically update the `messages` array when a new message arrives from the selected chat partner.

    ```javascript
    // frontend/src/store/useChatStore.js
    // ...
    subscribeToMessages: () => {
        const { selectedUser } = get();
        if(!selectedUser) return;
        
        const socket = useAuthStore.getState().socket; // Access socket from auth store
        socket.on("newMessage", (newMessage) => {
            if(newMessage.senderId !== selectedUser._id) return
            set({
                messages: [...get().messages, newMessage]
            })
        })
    },

    unsubscribeFromMessages: () => {
        const socket = useAuthStore.getState().socket;
        socket.off("newMessage");
    },
    // ...
    ```
    This crucial snippet demonstrates how `useChatStore` subscribes to real-time message updates. It retrieves the `socket` instance from `useAuthStore` and sets up an event listener for `newMessage`, ensuring that only messages relevant to the `selectedUser` are added to the current chat's state.
    [View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/store/useChatStore.js#L129-L144)

## Frontend Utilities

This section details common utility functions and configurations that enhance development efficiency and maintainability.

### Axios Instance (`axios.js`)

A custom Axios instance is configured to streamline API requests. It sets a base URL that adapts to the environment (development or production) and ensures that credentials (like cookies for session management) are sent with every request.

```javascript
// frontend/src/lib/axios.js
import axios from "axios";

export const axiosInstance = axios.create({
    baseURL: import.meta.env.MODE == "development" ? "http://localhost:5001/api": "/api",
    withCredentials: true,
});
```
This configuration is fundamental for all API interactions, ensuring consistent base URL resolution and handling of authenticated requests via cookies.
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/lib/axios.js#L1-L6)

### General Utilities (`utils.js`)

The `utils.js` file houses general-purpose utility functions that can be used across different components. Currently, it includes a function for formatting message timestamps.

```javascript
// frontend/src/lib/utils.js
export function formatMessageTime(date) {
    return new Date(date).toLocaleTimeString("en-US", {
        year: "numeric",
        month: "short",
        day:"2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
    });
}
```
This `formatMessageTime` function provides a consistent and readable format for displaying timestamps, improving user experience in chat interfaces.
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/frontend/src/lib/utils.js#L1-L10)

## Key Integration Points

The frontend architecture demonstrates robust integration across various components:

-   **Zustand Stores and API:** Both `useAuthStore` and `useChatStore` heavily rely on `axiosInstance` for interacting with the backend API. This separation of concerns means the stores dictate *what* data to fetch/send, while `axiosInstance` handles the *how* of the HTTP request.
-   **Zustand Stores and Socket.IO:** The `useAuthStore` is responsible for establishing and managing the core Socket.IO connection. The `useChatStore` then *subscribes* to events on this shared socket instance, particularly for real-time message updates, demonstrating a clean pattern for sharing singleton resources (like a socket connection) across different parts of the state.
-   **Environment Variables:** The `baseURL` for Axios and Socket.IO dynamically adjusts based on `import.meta.env.MODE`, ensuring smooth transitions between development and production environments.
-   **Toast Notifications:** `react-hot-toast` is integrated directly into store actions to provide immediate feedback to the user regarding success or failure of operations (e.g., login success, friend request failed).

This structured approach ensures that state management is centralized and predictable, API interactions are consistent, and real-time features are seamlessly integrated, all while promoting modularity and maintainability.