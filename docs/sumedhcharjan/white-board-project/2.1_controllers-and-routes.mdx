---
title: "Controllers and Routes"
description: "Explains the routing logic and controller functions that handle API requests."
sidebar_position: 21
---

# Controllers and Routes

This document explains the routing logic and controller functions that handle API requests in the `white-board-project`. It covers the `Room` and `Profile` routes and their respective controllers, outlining how requests are processed and how the application interacts with the database and other services.

## Room Management

The `Room` routes (`backend/routes/Room.routes.js`) and controller (`backend/controllers/Room.controller.js`) handle the creation, joining, and management of rooms for collaborative whiteboarding.

### Creating a Room

The `createRoom` function generates a unique room ID using `nanoid`, creates a new `Room` document in the database, and associates the user as the host. It also calls `createRoomDrawing` to initialize a drawing canvas for the room.

```javascript
// File: backend/controllers/Room.controller.js
import { nanoid } from "nanoid";
import Room from "../models/Room.model.js";
import { io } from '../lib/socket.js'
import { createRoomDrawing } from "../controllers/drawingcontroller.js"
export const createRoom = async (req, res) => {
    try {
        const { user } = req.body;

        if (!user || !user.sub) {
            return res.status(400).json({ msg: "Invalid user data" });
        }

        const roomid = nanoid(6);

        const room = new Room({
            roomid,
            hostuser: user.sub,
            participants: [],
            messages:[]
        });

        await room.save();
        await createRoomDrawing({roomid});
        res.status(200).json({ roomid });
    } catch (error) {
        console.error("Create room error:", error);
        res.status(500).json({ msg: "Server error", error });
    }
};
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/controllers/Room.controller.js)

### Joining a Room

The `joinRoom` function allows users to join an existing room. It checks if the room exists and if the user is already a participant. If not, it adds the user to the room's `participants` array and emits socket events to notify other participants.

```javascript
// File: backend/controllers/Room.controller.js
export const joinRoom = async (req, res) => {
    try {
        const { user, Rid } = req.body;
        const userId = user.sub;
        const userName = user.name || user.nickname || "Anonymous";

        const room = await Room.findOne({ roomid: Rid });
        if (!room) return res.status(404).json({ msg: 'Room not found' });

        const isAlreadyParticipant = room.participants.some(p => p.id === userId);
        if (isAlreadyParticipant) return res.status(400).json({ msg: 'Already in room' });
        const cd=(userId===room.hostuser);
        console.log(cd);
        room.participants.push({ id: userId, name: userName,candraw:cd});
        await room.save();
        io.to(Rid).emit('User Joined', { name: userName, userId });
        io.to(Rid).emit('participantsUpdate', room.participants)
        io.to(Rid).emit('joinroom', {
            name: userName,
            roomid: Rid,
            userid: userId,
        })
        res.status(200).json({ msg: 'Joined room', room });
    } catch (error) {
        console.error("Join room error:", error);
        res.status(500).json({ msg: "Server error", error });
    }
};
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/controllers/Room.controller.js)

### Leaving a Room

The `LeaveRoom` function handles the logic for a user leaving a room. If the user is the host, the room is deleted, and all participants are notified. Otherwise, the user is removed from the `participants` array.

```javascript
// File: backend/controllers/Room.controller.js
export const LeaveRoom = async (req, res) => {
    const { roomid, user } = req.body;
    try {
        const room = await Room.findOne({ roomid });
        if (!room) {
            return res.status(404).json({ error: 'Room not found' });
        }

        const userId = user.sub;
        const userName = user.name || user.nickname || 'Anonymous';

        if (userId === room.hostuser) {
            await Room.findOneAndDelete({ roomid });
            io.to(roomid).emit('hostEndedMeeting', { message: 'Host ended the meeting' });
            io.to(roomid).emit('participantsUpdate', []); // Empty array for consistency
            return res.status(200).json({ msg: 'Host ended the meeting' });
        }
        const participant = room.participants.find(p => p.id === userId);
        if (!participant) {
            return res.status(404).json({ error: 'Participant not found' });
        }
        room.participants = room.participants.filter(p => p.id !== userId);
        await room.save();

        io.to(roomid).emit('participantsUpdate', room.participants);
        io.to(roomid).emit('User Left', { name: userName, userId });
        res.json({ msg: 'Left the room successfully', participants: room.participants });
    } catch (error) {
        console.error('Error leaving room:', error.message, error.stack);
        res.status(500).json({ error: 'Server error' });
    }
};
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/controllers/Room.controller.js)

### Kicking a User

The `Kickuser` function allows the host of a room to remove a participant. It verifies that the request is made by the host and then removes the specified user from the `participants` array.

```javascript
// File: backend/controllers/Room.controller.js
export const Kickuser = async (req, res) => {
    try {
        const { userid, hostid, roomid } = req.body;
        const room = await Room.findOne({ roomid: roomid });
        if (!room) {
            return res.status(404).json({ error: 'Room not found' });
        }
        if (room.hostuser !== hostid) return res.status(404).json({ error: 'Only Host Can Kick participants' });
        const participant = room.participants.find(p => p.id === userid);
        if (!participant) {
            return res.status(404).json({ error: 'Participant not found' });
        }
        room.participants = room.participants.filter(p => p.id !== userid);
        await room.save();

        io.to(roomid).emit('participantsUpdate', room.participants);
        io.to(roomid).emit('Kickout', { userid, name: participant.name });
        res.json({ msg: 'Participant kicked out successfully', participants: room.participants });
    } catch (error) {
        console.error('Error kicking out participant:', error);
        res.status(500).json({ error: 'Server error' });
    }
}
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/controllers/Room.controller.js)

### Getting Room Details

The `SendRoomdetails` function retrieves and returns the details of a specific room based on its `roomid`.

```javascript
// File: backend/controllers/Room.controller.js
export const SendRoomdetails = async (req, res) => {
    try {
        const { roomid } = req.params;
        console.log(roomid);
        const room = await Room.findOne({ roomid: roomid });
        if (!room) return res.status(404).json({ msg: "Room not found" });

        res.json(room);
    } catch (error) {
        res.status(500).json({ msg: "Server error", error });
    }

}
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/controllers/Room.controller.js)

## Profile Management

The `Profile` routes (`backend/routes/Profile.routes.js`) and controller (`backend/controllers/Users.controller.js`) handle user-specific operations, such as retrieving and deleting saved drawings.

### Retrieving Saved Drawings

The `sendSavedDrawings` function retrieves saved drawings for a given user ID.

```javascript
// File: backend/routes/Profile.routes.js
import express from 'express'
import { deleteDrawing, sendSavedDrawings } from '../controllers/Users.controller.js';
const router=express.Router();


router.get('/:userid/savedDrawings',sendSavedDrawings);
router.delete('/:userid/deleteDrawing',deleteDrawing);
export default router;
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/routes/Profile.routes.js)

### Deleting a Drawing

The `deleteDrawing` function deletes a specific drawing associated with a user.

```javascript
// File: backend/routes/Profile.routes.js
import express from 'express'
import { deleteDrawing, sendSavedDrawings } from '../controllers/Users.controller.js';
const router=express.Router();


router.get('/:userid/savedDrawings',sendSavedDrawings);
router.delete('/:userid/deleteDrawing',deleteDrawing);
export default router;
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/routes/Profile.routes.js)

## Routing Configuration

The `express.Router` is used to define the API routes. Each route is associated with a specific controller function that handles the request.

```javascript
// File: backend/routes/Room.routes.js
import express from 'express'
import { createRoom, joinRoom, Kickuser, LeaveRoom, replyRequest, SendRoomdetails } from '../controllers/Room.controller.js';
import {
    getElements,
    clearElements
} from '../controllers/drawingcontroller.js'
import { saveDrawing } from '../controllers/Users.controller.js';
const router = express.Router();

router.post('/create', createRoom);
router.put('/joinroom', joinRoom);
router.put('/leave', LeaveRoom);
router.get('/roomdetails/:roomid', SendRoomdetails);
router.put('/kickout', Kickuser);
router.put('/request/p', replyRequest);
router.get("/getelements" , getElements)
router.delete("/clearelements",clearElements)
router.post('/savedrawing',saveDrawing);
export default router;
```

[View on GitHub](https://github.com/sumedhcharjan/white-board-project/blob/main/backend/routes/Room.routes.js)

## Room Management Flow





```mermaid
graph LR
    A["User Action (e.g., Create Room)"] --> B("API Route (e.g., /create)");
    B --> C["Controller Function (e.g., createRoom)"];
    C --> D{Database Interaction (e.g., Room.save())};
    D -- "Success" --> E("Response to User");
    D -- "Error" --> F("Error Handling");
    F --> E;
```



## Key Integration Points

- **Socket.IO:**  Real-time communication is facilitated using Socket.IO. When a user joins or leaves a room, or when the host ends the meeting, Socket.IO emits events to update all connected clients.  The `io.to(roomid).emit()` calls ensure that only users in the specific room receive the updates.
- **Database Interaction:** Mongoose is used to interact with the MongoDB database. The `Room` model represents the structure of the room data stored in the database. Controller functions use Mongoose methods like `findOne`, `save`, and `findOneAndDelete` to perform CRUD operations on the `Room` documents.
- **Error Handling:**  Each controller function includes a `try...catch` block to handle potential errors during the execution. In case of an error, a 500 status code is returned with an error message. Specific error messages, like "Room not found," are returned with appropriate status codes (e.g., 404).

Best Practices:
*   **Input Validation**: The `createRoom` controller validates the `user` data from the request body, ensuring the `user` object exists and contains a `sub` property, preventing errors from invalid or missing user information.
*   **Centralized Error Handling**: Consider implementing a middleware for centralized error handling to provide consistent error responses across the application. This could include logging errors, formatting responses, and setting appropriate HTTP status codes.
*   **Socket.IO Events**: Emitting specific Socket.IO events, such as `'User Joined'`, `'participantsUpdate'`, and `'User Left'`, allows clients to efficiently update their UI in real-time. The payloads of these events include the necessary data (e.g., user name, user ID, participant list) for the clients to update their state.
```