---
title: "Backend Development"
description: "Details on the server-side architecture and implementation."
---

# Backend Development

<TOC />

## Overview

This document details the backend architecture of the application, focusing on its structure, dependencies, and key functionalities.  The backend is built using Node.js with Express.js as the web framework and utilizes MongoDB for persistent data storage.  Authentication is handled through both email/password and Google OAuth 2.0. Real-time communication is facilitated by Socket.IO.

The project uses a modular design, separating concerns into distinct components like routes, models, and middleware for improved maintainability and scalability.


````mermaid
graph TD
    A[package.json] --> B(index.js);
    B --> C{Routes};
    C --> D[auth.route.js];
    C --> E[message.route.js];
    C --> F[friend.route.js];
    B --> G[models/];
    G --> H[user.model.js];
    B --> I[lib/];
    I --> J[db.js];
    I --> K[socket.js];
    I --> L[passport.config.js];
    B --> M[middleware/];
    M --> N[auth.middleware.js];
    B --> O[controllers/];


```

## Project Dependencies

The `package.json` file lists all project dependencies:

```json
{
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cloudinary": "^2.5.1",
    "cookie-parser": "^1.4.7",
    "dotenv": "^16.4.7",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^8.9.5",
    "passport": "^0.7.0",
    "passport-google-oauth20": "^2.0.0",
    "socket.io": "^4.8.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/package.json)

*   **`express`**:  The core web framework.
*   **`mongoose`**:  Provides an Object Data Modeling (ODM) library for interacting with MongoDB.
*   **`passport` & `passport-google-oauth20`**:  Enable authentication via various strategies, including Google OAuth.
*   **`bcryptjs`**:  For password hashing.
*   **`jsonwebtoken`**:  Used for creating and verifying JSON Web Tokens (JWTs) for authentication.
*   **`cookie-parser`**: Parses cookies from HTTP requests.
*   **`express-session`**:  Manages user sessions.
*   **`dotenv`**: Loads environment variables from a `.env` file.
*   **`cors`**: Enables Cross-Origin Resource Sharing (CORS) for requests from the frontend.
*   **`socket.io`**: Enables real-time bidirectional communication between the server and clients.
*   **`cloudinary`**: (Likely) used for image/file uploads and management.
*   **`nodemon`**:  A development tool for automatically restarting the server on code changes.


## Server Setup and Initialization (`index.js`)

The `index.js` file serves as the entry point for the backend:

```javascript
import express from "express";
// ... other imports

const app = express();
// ... middleware setup (cookieParser, json, urlencoded, cors, session, passport)

app.use("/api/auth", authRoutes);
app.use("/api/messages", messageRoutes);
app.use("/api/friends", friendRoutes);

// ... production setup for serving static files

server.listen(PORT, () => {
    console.log("server is running on PORT: " + String(PORT));
    connectDB();
});
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/index.js)

This code initializes the Express app, sets up middleware for handling requests (like parsing JSON and cookies, enabling CORS, and initializing Passport for authentication), mounts the API routes, and starts listening on the specified port.  The `connectDB()` function (not shown) establishes a connection to the MongoDB database.  Crucially, the server uses `express-session` to manage user sessions, and `passport` to handle authentication strategies.  The inclusion of `socket.io` integrates real-time capabilities.

## User Model (`user.model.js`)

The `user.model.js` file defines the schema for the `User` collection in MongoDB:

```javascript
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
    email: { type: String, required: true, unique: true },
    username: { type: String, required: true, unique: true, trim: true, minlength: 3, maxlength: 20 },
    password: { type: String, minlength: 6 },
    profilePic: { type: String, default: "" },
    friends: [{ type: mongoose.Schema.Types.ObjectId, ref: "User", default: [] }],
    friendRequests: [{ type: mongoose.Schema.Types.ObjectId, ref: "User", default: [] }],
    sentRequests: [{ type: mongoose.Schema.Types.ObjectId, ref: "User", default: [] }],
    authProvider: { type: String, enum: ['email', 'google'], default: 'email' },
    googleId: { type: String, unique: true, sparse: true }
}, { timestamps: true });

// ... pre-save hook

const User = mongoose.model("User", userSchema);

export default User;
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js)

This schema defines the fields for each user document, including email, username, password, profile picture, friends list, friend requests, and authentication provider.  The `timestamps` option automatically adds `createdAt` and `updatedAt` fields.  The `pre('save')` middleware handles password handling for different authentication methods.


````mermaid
classDiagram
    class User {
        -email : String
        -username : String
        -password : String
        -profilePic : String
        -friends : [ObjectId]
        -friendRequests : [ObjectId]
        -sentRequests : [ObjectId]
        -authProvider : String
        -googleId : String
    }
```

## Authentication Routes (`auth.route.js`)

The `auth.route.js` file defines the API endpoints for user authentication:

```javascript
import express from "express";
import passport from 'passport';
import { login, logout, signup, updateProfile, checkAuth, googleAuthCallback, checkUsernameAvailability} from  "../controllers/auth.controller.js"
import { protectRoute } from "../middleware/auth.middleware.js"

const router = express.Router();

router.post("/signup", signup);
router.post("/login", login);
router.post("/logout", logout);
router.put("/update-profile", protectRoute ,updateProfile);
router.get("/username/check/:username", protectRoute, checkUsernameAvailability);
router.get("/check", protectRoute, checkAuth);

router.get('/google', passport.authenticate('google', { scope: ['profile', 'email'] }));
router.get('/google/callback', passport.authenticate('google', { failureRedirect: 'http://localhost:5173/login', failureMessage: true }), googleAuthCallback);

export default router;
```

[Source](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/routes/auth.route.js)

This code sets up various routes for user signup, login, logout, profile updates, username availability checks, and Google OAuth 2.0 authentication.  The `protectRoute` middleware (not shown) protects certain routes, ensuring only authenticated users can access them.  The Google OAuth flow involves a redirect to Google for authentication and a callback to handle the response.

````mermaid
sequenceDiagram
    participant Client
    participant Server
    Client->>Server: Signup Request
    activate Server
    Server->>Server: Create User
    Server-->>Client: Success
    deactivate Server
    Client->>Server: Login Request
    activate Server
    Server->>Server: Authenticate User
    Server-->>Client: Token
    deactivate Server

```


Next: [Backend APIs](./2.1_backend_apis.mdx)