---
title: "Backend Database and Models"
description: "Explanation of the database schema and models."
---

# Backend Database and Models

<TOC />

## Database Connection

The backend application uses MongoDB as its database.  The `connectDB` function in [`backend/src/lib/db.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/db.js) handles the connection process.

```javascript
import mongoose from "mongoose"

export const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI);
    console.log(`MongoDB connected:  ${conn.connection.host}`);
  }
  catch(error){
    console.log("MongoDB connection error: ", error);
  }
}
```

This function utilizes the `mongoose` library to establish a connection to the MongoDB instance whose URI is stored in the environment variable `MONGODB_URI`.  The `async/await` syntax makes the connection process non-blocking.  On successful connection, a confirmation message is logged to the console; otherwise, any errors are logged.  This ensures that the application gracefully handles potential connection failures.

## User Model

The `User` model, defined in [`backend/src/models/user.model.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/user.model.js), represents users within the application.

```javascript
import mongoose from "mongoose"

const  userSchema = new mongoose.Schema(
    {
        email: { 
            type: String,
            required: true,
            unique: true
        },
        username: {
            type: String,
            required: [true, "Username is required"],
            unique: true,
            trim: true,
            minlength: [3, "Username must be at least 3 characters long"],
            maxlength: [20, "Username cannot be more than 20 characters long"]
        },
        password: {
            type: String,
            minlength: 6,
        },
        // ... other fields
    },
    { 
        timestamps: true
    } 
);

// ... pre-save middleware ...

const User = mongoose.model("User", userSchema);

export default User;
```

The schema includes fields for `email`, `username`, `password`, `profilePic`, `friends`, `friendRequests`, `sentRequests`, `authProvider`, and `googleId`.  Validation rules ensure data integrity (e.g., required fields, unique email/username, minimum password length).  The `timestamps: true` option automatically adds `createdAt` and `updatedAt` fields.  The `pre('save')` middleware handles password management for different authentication providers.  If authentication is via Google, the password field is set to `undefined`. If email signup is used and password is not provided, an error is thrown.

### User Model Relationships

The `User` model utilizes `mongoose.Schema.Types.ObjectId` and `ref: "User"` to establish relationships with other `User` documents:

*   **friends:** An array of `ObjectId`s referencing users who are friends with this user.
*   **friendRequests:** An array of `ObjectId`s referencing users who have sent friend requests to this user.
*   **sentRequests:** An array of `ObjectId`s referencing users to whom this user has sent friend requests.

This design allows for efficient management of user friendships and pending requests.


## Message Model

The `Message` model, defined in [`backend/src/models/message.model.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/models/message.model.js), represents messages exchanged between users.

```javascript
import mongoose from "mongoose";

const messageSchema = new mongoose.Schema(
    {
     senderId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     receiverId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User",
        required: true,
     },
     text: {
        type: String,
     },
     image: {
        type: String,
     },
    },
    {timestamps: true}
);

export default mongoose.model("Message", messageSchema);
```

The schema includes fields for `senderId`, `receiverId`, `text`, and `image`.  `senderId` and `receiverId` are `ObjectId`s referencing the `User` model, establishing a clear relationship between messages and users.  The `timestamps: true` option adds timestamps for message creation and modification.


### Message Model Relationships

The `Message` model uses `mongoose.Schema.Types.ObjectId` and `ref: "User"` to reference the `User` model for both `senderId` and `receiverId`. This creates a many-to-many relationship between users and messages; a user can send and receive multiple messages.


## Database Schema Diagram

````mermaid
classDiagram
    class User {
        -email : String
        -username : String
        -password : String
        -profilePic : String
        -friends : [ObjectId]
        -friendRequests : [ObjectId]
        -sentRequests : [ObjectId]
        -authProvider : String
        -googleId : String
    }
    class Message {
        -senderId : ObjectId
        -receiverId : ObjectId
        -text : String
        -image : String
    }
    User "1" -- "*" Message : sends
    User "1" -- "*" Message : receives
```


## File Structure Diagram

````mermaid
graph TD
    A[backend] --> B(src);
    B --> C(lib);
    C --> D{db.js};
    B --> E(models);
    E --> F{user.model.js};
    E --> G{message.model.js};

```

Next: [Frontend Development](./3_frontend.mdx)