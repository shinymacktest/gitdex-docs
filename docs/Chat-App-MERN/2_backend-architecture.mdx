---
title: "Backend Architecture"
description: "Detailed structure and components of the server-side application."
sidebar_position: 2
---

---
title: "Backend Architecture"
description: "Detailed structure and components of the server-side application."
sidebar_position: 2
---

# Backend Architecture

<TOC />

This section provides a comprehensive overview of the backend architecture, detailing its core components, technologies, and how they interact to form the server-side foundation of the application. The backend is built on Node.js with the Express framework, leveraging a MongoDB database for data persistence and Socket.IO for real-time communication.

## Core Technologies and Dependencies

The `package.json` file reveals the critical dependencies used in the backend. These libraries underpin various functionalities from authentication to database interactions and real-time messaging.

```json title="backend/package.json"
{
  "name": "backend",
  "version": "1.0.0",
  "main": "src/index.js",
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js"
  },
  "type": "module",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cloudinary": "^2.5.1",
    "cookie-parser": "^1.4.7",
    "dotenv": "^16.4.7",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^8.9.5",
    "passport": "^0.7.0",
    "passport-google-oauth20": "^2.0.0",
    "socket.io": "^4.8.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}
```
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/package.json)

**Key Dependencies:**

*   **`express`**: The primary web framework for building RESTful APIs.
*   **`mongoose`**: An ODM (Object Data Modeling) library for MongoDB, providing a straightforward, schema-based solution to model application data.
*   **`socket.io`**: Enables real-time, bidirectional event-based communication between the client and server, crucial for instant messaging and online user presence.
*   **`bcryptjs`**: Used for hashing passwords securely.
*   **`jsonwebtoken`**: For implementing token-based authentication (JWT).
*   **`cookie-parser`**: Parses cookies attached to the client request object.
*   **`dotenv`**: Loads environment variables from a `.env` file, keeping sensitive configurations out of the codebase.
*   **`express-session`** and **`passport`**: For managing user sessions and providing various authentication strategies, including Google OAuth 2.0.
*   **`cloudinary`**: Integration for cloud-based image and video management (e.g., user profile pictures).

## Application Entry Point (`index.js`)

The `src/index.js` file serves as the main entry point for the backend application. It initializes the Express app, sets up middleware, configures routes, connects to the database, and starts the server.

```javascript title="backend/src/index.js"
import express from "express";
import cors from "cors";
import authRoutes from "./routes/auth.route.js";
import messageRoutes from "./routes/message.route.js";
import friendRoutes from "./routes/friend.route.js";

import path from "path";

import dotenv from "dotenv";
import cookieParser from "cookie-parser";

import { connectDB } from "./lib/db.js";
import { app, server } from "./lib/socket.js"; // Import 'app' and 'server' from socket.js

import session from "express-session";
import passport from "passport";
import { configurePassport } from "./lib/passport.config.js";

const __dirname = path.resolve();
dotenv.config();

configurePassport(); // Initialize Passport strategies

app.use(cookieParser());
app.use(express.json({limit : '2mb'}));
app.use(express.urlencoded({ limit: '2mb', extended: true }));
app.use(cors({
    origin: "http://localhost:5173", // Frontend origin
    credentials: true,
}));

app.use(session({
    secret: process.env.SESSION_SECRET, 
    resave: false,
    saveUninitialized: false, 
    cookie: {
        secure: process.env.NODE_ENV === "production", // true in production (HTTPS)
        httpOnly: true,
        maxAge: 7 * 24 * 60 * 60 * 1000 
    }
}));

app.use(passport.initialize());
app.use(passport.session());  

app.use("/api/auth", authRoutes );
app.use("/api/messages", messageRoutes );
app.use("/api/friends", friendRoutes);


const PORT = process.env.PORT;
if(process.env.NODE_ENV === "production"){
    app.use(express.static(path.join(__dirname, "../frontend/dist")));
    
    app.get("*" , (req, res) => {
        res.sendFile(path.join(__dirname,"../frontend", "dist","index.html"));
    })
}

server.listen(PORT, () => {
    console.log("server is running on PORT: " + String(PORT));
    connectDB(); // Connect to MongoDB
});
```
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/index.js)

**Key Aspects:**

*   **Middleware Setup**:
    *   `cookieParser()`: Parses incoming cookies.
    *   `express.json()` and `express.urlencoded()`: Parse JSON and URL-encoded request bodies, respectively, with a 2MB limit to prevent oversized payloads.
    *   `cors()`: Configured to allow requests from the frontend origin (`http://localhost:5173`) and enable credential (cookie) sharing.
    *   `express-session` and `passport`: Used for session management and authentication, including session persistence and deserialization.
*   **Route Handling**: The application defines modular routes for authentication, messages, and friend management, making the codebase organized and maintainable.
*   **Production Build Handling**: In production, the backend serves the static files of the frontend build, ensuring a seamless single-origin deployment.

## Database Connection (`db.js`)

The `src/lib/db.js` file encapsulates the logic for connecting to the MongoDB database using Mongoose.

```javascript title="backend/src/lib/db.js"
import mongoose from "mongoose"

export const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI);
    console.log(`MongoDB connected:  ${conn.connection.host}`);
  }
  catch(error){
    console.log("MongoDB connection error: ", error);
  }
}
```
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/db.js)

The `connectDB` function attempts to establish a connection to MongoDB using the URI provided in the environment variables. It logs a success message with the host if the connection is established or an error message if it fails.

## Real-time Communication (`socket.js`)

The `src/lib/socket.js` file sets up the Socket.IO server, enabling real-time functionalities such as instant messaging and tracking online users. It exports the Express `app` instance, the HTTP `server`, and the `io` (Socket.IO server) instance for global use.

```javascript title="backend/src/lib/socket.js"
import { Server } from "socket.io";
import http from "http";
import express from "express";

const app = express();

const server = http.createServer(app);

const io = new Server(server, {
    cors: {
        origin: ["http://localhost:5173"] // Frontend origin for Socket.IO
    }
})

export function getReceiverSocketId(userId) {
    return userSocketMap[userId];
}

// used to store online users
const userSocketMap = {}; //{userId : socketId}

io.on("connection", (socket) => {
    console.log("A user connected", socket.id);

    const userId = socket.handshake.query.userId;
    if(userId) userSocketMap[userId] = socket.id;

    // Emit online users to all connected clients
    io.emit("getOnlineUsers", Object.keys(userSocketMap));

    socket.on("disconnect", ()=>{
        console.log("A user disconnected", socket.id);
        delete userSocketMap[userId]; 
        io.emit("getOnlineUsers", Object.keys(userSocketMap));
    })
})

export { io, app, server };
```
[View on GitHub](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/socket.js)

**Key Features:**

*   **HTTP Server Integration**: The Socket.IO server (`io`) is initialized on top of the standard HTTP server (`server`) that also handles Express requests, sharing the same port.
*   **CORS Configuration**: Socket.IO also requires its own CORS configuration, ensuring that connections are accepted from the frontend.
*   **`userSocketMap`**: An object `userSocketMap` stores the `userId` to `socket.id` mapping, allowing the server to identify which socket belongs to which user.
*   **Connection/Disconnection Events**:
    *   On `"connection"`, a user's `userId` (from the handshake query) is mapped to their `socket.id`, and the updated list of online users is broadcast to all clients.
    *   On `"disconnect"`, the user is removed from the `userSocketMap`, and the online user list is updated.
*   **`getReceiverSocketId`**: A utility function to retrieve a specific user's socket ID, enabling direct messaging.

## Backend Architectural Flow

The diagram below illustrates the high-level request flow and component interactions within the backend architecture.





```mermaid
graph TD
    A["Client (Frontend)"] -->|HTTP/S Request| B["Express App (index.js)"]
    B -->|Middleware Processing| C["cookieParser, CORS, Auth, Session"]
    C -->|Route Handling: /api/*| D["Auth/Message/Friend Routes"]
    D -->|Calls Controllers| E["Controller Functions"]
    E -->|Interact with DB| F["MongoDB (via Mongoose)"]
    E -->|Real-time Events| G["Socket.IO Server"]
    G -->|Broadcast Events| A
    B -->|Serves Static Files (Prod)| A
    B -->|Database Connection| F
```



**Explanation of Flow:**

1.  **Client Request**: The frontend sends an HTTP/S request (e.g., for login, sending a message) to the backend.
2.  **Express App**: The `index.js` file receives the request via the Express app.
3.  **Middleware**: The request passes through various middleware (cookie parsing, CORS, authentication, session management).
4.  **Route Handling**: Based on the URL path (e.g., `/api/auth`, `/api/messages`), the request is directed to the appropriate route handler.
5.  **Controller Functions**: Route handlers invoke controller functions that contain the core business logic.
6.  **Database Interaction**: Controllers interact with MongoDB (through Mongoose) to perform CRUD operations.
7.  **Real-time Events**: For functionalities like messaging or online status, controllers may trigger events through the Socket.IO server.
8.  **Broadcast to Client**: The Socket.IO server broadcasts real-time updates back to connected clients.
9.  **Static File Serving**: In production, the Express app also serves the compiled frontend assets.
10. **Database Connection**: The Express app initializes the connection to MongoDB upon server startup.

## Real-time Communication Workflow

This sequence diagram details how a user's online status is managed and broadcast using Socket.IO.





```mermaid
sequenceDiagram
    participant C as "Client (Browser)"
    participant E as "Express Server (HTTP)"
    participant S as "Socket.IO Server (socket.js)"
    participant M as "User Socket Map"

    C->>+S: "Socket.io Connection Request with userId"
    S->>M: "Store: userId -> socketId"
    S->>S: "Generate 'getOnlineUsers' payload"
    S-->>C: "Emit 'getOnlineUsers' to all connected clients"
    C->>E: "User logs in (e.g., POST /api/auth/login)"
    E-->>C: "Authentication successful, sets cookie"
    C->>-S: "User closes tab or disconnects"
    S->>M: "Delete: userId -> socketId"
    S->>S: "Generate updated 'getOnlineUsers' payload"
    S-->>C: "Emit 'getOnlineUsers' to remaining clients"
```



**Workflow Explanation:**

1.  **Client Connects**: When a client initializes a Socket.IO connection, it sends its `userId` in the handshake query.
2.  **Server Stores Socket ID**: The `Socket.IO Server` receives the connection, extracts the `userId`, and stores the mapping of `userId` to `socketId` in the `User Socket Map`.
3.  **Broadcast Online Users**: The `Socket.IO Server` then compiles a list of all currently online users (from the map) and broadcasts it to all connected clients via the `"getOnlineUsers"` event.
4.  **User Logs In (HTTP)**: Separately, standard HTTP requests are handled by the `Express Server` for authentication, which might set HTTP-only cookies.
5.  **Client Disconnects**: When a client disconnects (e.g., closes the browser tab), the `Socket.IO Server` detects the disconnection.
6.  **Remove from Map**: The server removes the corresponding `userId` from the `User Socket Map`.
7.  **Update Online Users**: An updated list of online users is generated and broadcast to all remaining connected clients.

## Key Integration Points

*   **Authentication and Real-time**: While authentication primarily uses HTTP-based routes and cookies/sessions, the `userId` obtained after a successful login is critical for Socket.IO to map users to their sockets, enabling personalized real-time communication.
*   **Database and Controllers**: All data manipulation, retrieval, and storage logic resides within controllers, which interact exclusively with MongoDB through Mongoose models. This separation of concerns ensures maintainability and scalability.
*   **Environment Variables**: Crucial for sensitive information like `MONGODB_URI`, `SESSION_SECRET`, and API keys. Using `dotenv` ensures these are securely managed and not hardcoded.
*   **CORS**: Correct CORS configuration is essential for both Express and Socket.IO to allow cross-origin requests from the frontend, especially during development. In production, serving static files from the backend can mitigate some CORS complexities.

Next: [API Endpoints and Controllers](./2.1_api-endpoints-and-controllers.mdx)
```