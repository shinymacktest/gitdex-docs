---
title: "Authentication with Google OAuth"
description: "Detailed explanation of user authentication using Passport.js and Google OAuth20."
---
<TOC />

# Authentication with Google OAuth

The application implements user authentication using Passport.js with the Google OAuth20 strategy. This allows users to sign in securely using their Google accounts.

## Passport Configuration (`lib/passport.config.js`)

The `lib/passport.config.js` file is responsible for setting up the Google authentication strategy and defining how user data is serialized and deserialized for session management.

```javascript
// backend/src/lib/passport.config.js
import passport from 'passport';
import { Strategy as GoogleStrategy } from 'passport-google-oauth20';
import User from '../models/user.model.js';
import dotenv from 'dotenv';

dotenv.config();

export const configurePassport = () => {
    passport.use(new GoogleStrategy({
        clientID: process.env.GOOGLE_CLIENT_ID,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET,
        callbackURL: process.env.GOOGLE_CALLBACK_URL,
        scope: ['profile', 'email']
    },
    async (accessToken, refreshToken, profile, done) => {
        // ... (user find/create logic) ...
    }));

    passport.serializeUser((user, done) => {
        done(null, user.id);
    });

    passport.deserializeUser(async (id, done) => {
        try {
            const user = await User.findById(id);
            done(null, user);
        } catch (error) {
            done(error, null);
        }
    });
};
```
[Source: `backend/src/lib/passport.config.js`](https://github.com/shinymack/Chat-App-MERN/blob/main/backend/src/lib/passport.config.js)

### Google Strategy

The `GoogleStrategy` is initialized with environment variables for `clientID`, `clientSecret`, and `callbackURL`. The `scope` parameter requests access to the user's basic `profile` information and `email`.

The core logic resides in the `async (accessToken, refreshToken, profile, done)` callback:

1.  **User Lookup**: It attempts to find a user in the database using their `googleId` (from `profile.id`).
2.  **Existing User**: If found, the existing user is returned (`done(null, user)`).
3.  **New User Creation**: If not found:
    *   A unique `username` is generated from `profile.displayName`.
    *   Checks are performed to ensure uniqueness of the generated username and to prevent creating a Google-linked account if an account with the same email already exists via a different authentication provider.
    *   A new `User` document is created with the `googleId`, `email`, generated `username`, and `authProvider: 'google'`.
    *   The new user is saved to the database and returned.

### Session Management

*   **`passport.serializeUser`**: This function is called after a user is successfully authenticated. It determines what data about the user should be stored in the session. In this case, only the user's MongoDB `_id` is stored.
*   **`passport.deserializeUser`**: This function is called on subsequent requests where a session is present. It takes the stored `id` (from `serializeUser`), fetches the full user object from the database, and attaches it to `req.user`, making user data accessible in controllers.

## Google OAuth 2.0 Flow

The authentication process follows the standard OAuth 2.0 authorization code grant flow:

````mermaid
sequenceDiagram
    participant U as User
    participant C as Client (Frontend)
    participant B as Backend (Express)
    participant P as Passport.js
    participant G as Google Auth Server
    participant DB as MongoDB

    C->>B: GET /api/auth/google (Login Request)
    B->>P: Trigger GoogleStrategy
    P->>G: Redirect User (302) to Google Login/Consent
    G-->>U: Google Login Page (User interacts)
    U->>G: User grants/denies access
    G->>B: Redirect to callbackURL (/api/auth/google/callback) with code
    B->>P: Exchange code for tokens & profile
    P->>G: Validate code & get profile
    G-->>P: Access Token & User Profile
    P->>B: Invoke verify callback (async function)
    B->>DB: Find/Create User based on Google Profile
    alt User Found
        DB-->>B: Existing User
    else User Not Found
        B->>DB: Create New User
        DB-->>B: New User Created
    end
    B->>P: Pass User to Passport
    P->>B: serializeUser(user)
    B-->>C: Set Session Cookie & Redirect (e.g., to dashboard)
    C->>B: Subsequent requests (with session cookie)
    B->>P: deserializeUser(id)
    P->>DB: Fetch user by ID
    DB-->>P: User data
    P->>B: User object attached to req.user
```
<!-- Fixed Mermaid syntax -->

This flow ensures secure delegation of user authentication to Google, while the backend maintains session state for authenticated users.

Next: [Backend API Reference](3_api_reference.mdx)